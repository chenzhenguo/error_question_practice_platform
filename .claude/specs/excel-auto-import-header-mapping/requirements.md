# Excel试题导入：基于首行表头的自动匹配与导入

## 简介
本特性提供从 Excel 文件（含首行表头）自动识别并匹配试题字段的能力，支持用户上传包含以下中文表头的试题数据：
`日期、题目来源、考试优先级、题号、题型、知识点、具体考点、题目、选项、我的答案、正确答案、考点解析、题型/错因标签、错误原因、正确思路/口诀、复习1、复习2、复习3、状态`。
系统根据首行表头自动完成字段映射、数据校验与规范化，并提供映射预览、行级错误高亮、进度与统计，以减少手工配置并提高导入效率与准确性。

---

## 1. 表头识别与字段自动映射
- 用户故事：作为试题维护者，我希望系统能根据 Excel 首行表头自动匹配试题字段，这样我无需逐列手动映射即可快速导入。
- 验收标准（EARS）：
  1.1 当用户上传包含首行表头的 Excel/CSV 文件时，系统应将第一行识别为字段名并进行去空格/去首尾空白/中文全角转半角处理。
  1.2 当表头与支持列表（日期/题目来源/考试优先级/题号/题型/知识点/具体考点/题目/选项/我的答案/正确答案/考点解析/题型-错因标签/错误原因/正确思路-口诀/复习1/复习2/复习3/状态）存在完全匹配时，系统应将该列自动映射到对应内部字段（如：`日期->createdAt`，`题型->type`，`题目->question`，`正确答案->answer`）。
  1.3 在表头存在常见同义词或变体（如“题目/内容”，“正确答案/答案”，“考点解析/解析”，“题型/题目类型”，“题型-错因标签/标签/错因标签”）时，系统应进行同义映射并记录匹配来源（精确/模糊）。
  1.4 当存在未知表头或不在支持列表中时，系统应将该列标记为“未映射”，并在预览中提示但不阻塞导入。
  1.5 在表头缺失的情况下，如果缺失列属于必需字段（“题目”、“正确答案”），系统应在预览中高亮并禁止导入；否则允许导入并对缺失字段使用默认值或警告。

## 2. 字段定义与内部数据模型映射
- 用户故事：作为系统使用者，我希望导入后的数据能映射到标准的内部数据模型，使导入结果可被后续模块（编辑、练习、导出）一致使用。
- 验收标准（EARS）：
  2.1 当“日期”存在时，系统应将其解析为 ISO 日期并映射到 `createdAt`（若格式不合法，则记录警告并回退为当前时间，同时保留原始值用于审计）。
  2.2 当“题目来源”存在时，系统应映射到 `source`（字符串）。
  2.3 当“考试优先级”存在时，系统应映射到 `priority`（字符串或受限枚举，保留原值）。
  2.4 当“题号”存在时，系统应映射到 `questionNumber`（字符串）。
  2.5 当“题型”存在时，系统应映射到 `type`（如“选择题/填空题/简答题”等，保留原值）。
  2.6 当“知识点”存在时，系统应映射到 `knowledge`（字符串）。
  2.7 当“具体考点”存在时，系统应映射到 `specificKnowledge`（字符串）。
  2.8 当“题目”存在时，系统应映射到 `question`（字符串，必需字段）。
  2.9 当“选项”存在时，系统应映射到 `options`（字符串或结构化；初版保留原字符串，后续可拓展解析 A/B/C/D）。
  2.10 当“我的答案”存在时，系统应映射到 `myAnswer`（字符串）。
  2.11 当“正确答案”存在时，系统应映射到 `answer`（字符串，必需字段）。
  2.12 当“考点解析”存在时，系统应映射到 `analysis`（字符串）。
  2.13 当“题型/错因标签”存在时，系统应映射到 `tags`（字符串；系统应将分隔符【，,、/空格】统一规范化为逗号）。
  2.14 当“错误原因”存在时，系统应映射到 `errorReason`（字符串）。
  2.15 当“正确思路/口诀”存在时，系统应映射到 `correctMethod`（字符串）。
  2.16 当“复习1/复习2/复习3”存在时，系统应分别映射到 `review1/review2/review3`（字符串）。
  2.17 当“状态”存在时，系统应映射到 `status`（字符串；保留原值，示例：active/inactive/error/archived 等）。
  2.18 当数据行缺少 `id` 时，系统应为每条记录生成唯一 `id`（形如 `Q<time><rand>`）。

## 3. 数据校验与规范化
- 用户故事：作为导入操作者，我希望系统在导入前能自动检查格式并给出修正意见，避免错误数据进入系统。
- 验收标准（EARS）：
  3.1 当检测到必需字段缺失（题目/正确答案）时，系统应在预览中按行高亮并禁止提交导入。
  3.2 当检测到日期格式不合法时，系统应记录行级警告并将其规范化为当前时间（同时保留原始值用于审计）。
  3.3 当检测到空白行或全为空值行时，系统应自动忽略该行并在统计中计入“忽略行数”。
  3.4 当检测到标签字段包含多种分隔符时，系统应统一规范化为逗号分隔。
  3.5 当检测到可能重复记录时，系统应在执行严格文本归一化后进行比较并判定重复：归一化包含去空格（含全角/半角）、移除或统一标点、大小写统一、全角半角与中英文符号统一、连续空白合并；在“题目+正确答案”归一化后完全一致或高度相似（相似度阈值≥0.95）时标记为“可能重复”，并提供“跳过/合并/仍然导入”的选项（初版默认跳过）。

## 4. 导入流程与用户体验
- 用户故事：作为用户，我希望在导入前能查看映射预览与行级错误信息，以确保导入结果正确。
- 验收标准（EARS）：
  4.1 当用户选择 Excel/CSV 文件后，系统应显示“字段映射预览”（包括匹配成功/同义匹配/未映射列）与“数据预览”（前 N 行示例）。
  4.2 当用户点击“开始导入”时，系统应执行行级校验与规范化，并在结果面板展示“成功/跳过/错误”的统计。
  4.3 在导入进行中，系统应显示进度与当前处理行号，并在大文件时采用分批读取策略以保持页面可用性。
  4.4 导入成功后，系统应触发事件 `eqpp:questions:updated` 并将数据写入内部存储（`eqpp.questions`），供原始编辑器/练习/导出模块使用。
  4.5 当导入失败（例如文件损坏/无法解析）时，系统应显示英文错误信息并提供重新选择文件入口。

## 5. 边界情况与兼容性
- 用户故事：作为维护者，我希望系统能合理处理异常 Excel 格式与表头变体，提高导入鲁棒性。
- 验收标准（EARS）：
  5.1 当 Excel 存在多工作表时，系统应默认读取第一个工作表并提供工作表切换（初版可固定第一个）。
  5.2 当表头存在合并单元格或多行表头时，系统应仅使用第一行作为表头，并忽略合并影响（以第一行文本为准）。
  5.3 当表头存在重复（同时出现“题目”与“内容”等）时，系统应采用优先级策略并在预览中提示重复处理规则（例如优先“题目”，保留“内容”为未映射）。
  5.4 当文件为 CSV 时，系统应支持按首行逗号分隔并套用同样的映射与校验规则。
  5.5 当文件体积较大（例如≥10,000 行）时，系统应采用分页/分批处理并限制内存占用，保持 UI 响应。

## 6. 错误处理与日志
- 用户故事：作为用户，我希望导入过程中的错误能被清晰记录并便于定位问题。
- 验收标准（EARS）：
  6.1 当发生解析错误时，系统应在控制台输出调试日志（含行号/列名/原始值）并在 UI 显示摘要。
  6.2 当发生字段映射失败时，系统应在预览中列出未映射列及建议的同义词。
  6.3 当用户取消导入或关闭弹窗时，系统应终止导入过程并清理临时数据，不修改存储。

## 7. 成功准则
- 用户故事：作为产品负责人，我希望有明确的完成标准，确保功能可用与稳定。
- 验收标准（EARS）：
  7.1 当用户上传包含上述表头的 Excel 并完成导入时，系统应在 3 步内完成（选择文件→预览→确认导入）。
  7.2 当导入完成后，系统应保证至少 95% 的列能正确自动映射（基于给定表头列表与同义词），其余列提示未映射但不阻塞。
  7.3 当导入完成后，系统应可在“原始编辑器/练习/导出”模块中正确读取导入数据且无异常跳转。

## 8. 待澄清/可扩展点（建议）
- 是否需要支持更多同义/英文表头（如：日期→时间/录入日期；题型→题目类型；内容→题目；解析→考点解析）？
- “选项”字段是否需要结构化解析为 A/B/C/D（初版保留字符串，后续版本可升级）？
- “状态”字段的取值域是否需要约束与字典（例如：active/inactive/error/archived）？
- 是否允许将“状态=错题”的行导入到 `eqpp.errorQuestions`（或双写）？
- 重复判断策略是否需要更精细（例如：题目文本归一化后+答案完全一致才视为重复）？
- 大文件导入是否需要断点续导或后台导入机制？