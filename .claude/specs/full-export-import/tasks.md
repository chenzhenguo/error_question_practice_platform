# 全量导出/导入（含合并导入）实施计划任务清单

说明：以下任务清单为代码生成型 LLM 的分步实现提示，遵循测试驱动（先写测试后实现），每一步均为可执行的编码任务。仅包含可以通过编写/修改/测试代码完成的事项。每个任务均引用需求文档中的具体条目（如 Req 1.1 表示《requirements.md》中第 1 章第 1 条）。

1. [ ] 导出控制器：组装备份 JSON 与下载（基础）
   - 目标：在 `src/rror_question_practice_platform.html` 的导出逻辑中，确保备份 JSON 包含完整 `meta` 与 `payload` 键，并通过 `Blob + URL.createObjectURL` 下载（文件名 `eqpp_backup_{timestamp}.json`）。
   - 参考需求：Req 1.1, 1.2, 1.3, 1.4, 1.5, 1.6
   - 子任务：
     - 1.1. [ ] 编写/完善 `collectPracticeFilters()`，收集所有以 `practiceFilter:` 开头的键，返回 `{ key: value }` 映射（先写单元测试：断言收集的键数量与命名规则）。
     - 1.2. [ ] 编写/完善 `getJSON/setJSON` 包装，保证空缺键返回合理默认值（对象 `{}`、数组 `[]`），类型不符时容错（测试：传入无效类型时返回默认值）。
     - 1.3. [ ] 生成包含 `meta`（`app`, `feature`, `timestamp`, `version?`, `note?`）与完整 `payload` 的对象，并序列化为字符串；使用 `Blob` 触发下载（测试：`FullBackupTest#testFullExportJsonStructure` 扩展断言）。

2. [ ] 导入控制器：覆盖式导入（Overwrite）
   - 目标：当选择覆盖模式时，直接用备份 `payload` 覆盖本地同名键，并写入 `practiceFilter:*` 快照；派发事件与刷新 UI。
   - 参考需求：Req 2.1, 2.2, 2.3, 2.4, 2.5
   - 子任务：
     - 2.1. [ ] 将覆盖逻辑提炼为 `applyOverwriteImport(payload)` 函数，包含所有键写入与过滤规则写入（先写测试：模拟 `payload`，断言关键键值被覆盖）。
     - 2.2. [ ] 在导入完成后派发更新事件并调用刷新方法（测试：可通过模拟事件触发次数或标记变量验证被调用）。

3. [ ] 导入控制器：合并式导入（Merge）
   - 目标：按 `id` 合并题库与错题、重建 `eqpp.*` 映射、学习数据/索引合并、设置与模板浅合并、过滤规则覆盖同名键。
   - 参考需求：Req 3.1, 3.2, 3.3, 3.4, 3.5, 3.6, 3.7, 3.8, 3.9, 3.10
   - 子任务：
     - 3.1. [ ] 实现 `mergeArrayById(currentArr, incomingArr)`：缺失 `id` 自动生成；同 `id` 的对象字段以备份覆盖；返回合并数组（先写测试：去重与覆盖行为）。
     - 3.2. [ ] 实现 `rebuildEqppQuestions(questions)`：字段标准化（`question`, `answer`, `tags`, `createdAt` 等）；与 `saveQuestions` 映射一致（测试：传入混合字段的输入，断言输出规范化）。
     - 3.3. [ ] 为错题映射生成器编写函数（如 `rebuildEqppErrorQuestions(errorQuestions)`），包含 `errorCount`, `lastErrorTime`, `createdAt`（测试：字段完整性与默认值）。
     - 3.4. [ ] 实现 `mergeStudyData(cur, inc)`：计数求和、`studyDays` 取较大、其余备份覆盖（测试：数值累加与最大值逻辑）。
     - 3.5. [ ] 实现 `mergeStudyIndex(cur, inc)`：相同 `id` 的 `answeredCount` 累加，`lastAnsweredTime` 取最新（测试：时间对比与计数累加）。
     - 3.6. [ ] 实现 `mergeShallow(cur, inc)`：用于 `practiceSettings` 与 `dailyPracticeSettings`（测试：保留本地键 + 覆盖同名键）。
     - 3.7. [ ] 实现 `mergeArraySimple(cur, inc)`：用于 `eqpp.batches`（优先按 `id` 去重，否则按内容串去重；测试：重复元素仅一次）。
     - 3.8. [ ] 在 `applyMergeImport(payload)` 中组合上述合并函数，重建 `eqpp.*` 并落库；过滤规则以备份覆盖同名键（测试：`FullBackupTest#testMergeImportMode` 扩展断言更多键）。
     - 3.9. [ ] 导入完成后派发更新事件与刷新 UI（测试：与覆盖式导入一致）。

4. [ ] 解析与错误处理（健壮性）
   - 目标：对读取/解析错误、结构不合法、类型不符进行健壮处理，使用英文错误提示并不中断页面状态。
   - 参考需求：Req 2.2, 6.1, 6.2, 6.3
   - 子任务：
     - 4.1. [ ] 将 `FileReader` 读取失败路径与 JSON 解析失败路径分别处理，弹出英文错误提示（测试：模拟异常路径，断言提示与不落库）。
     - 4.2. [ ] 当 `payload` 缺失或类型不符时，中止导入并提示（测试：缺失字段/错误类型）。
     - 4.3. [ ] 对异常字段采用默认值或跳过并继续（测试：异常字段不影响整体导入）。

5. [ ] 一致性与缓存清理保留键验证
   - 目标：导入后 `eqpp.*` 与主数据保持一致；缓存清理时保留 `eqpp.studyIndex`，避免答题历史丢失。
   - 参考需求：Req 4.1, 4.2, 4.3, 4.4
   - 子任务：
     - 5.1. [ ] 编写测试：导入后 `eqpp.questions` 与 `questions` 在关键字段上保持语义一致（例如 `tags` 标准化与 `createdAt` 格式）。
     - 5.2. [ ] 编写测试：缓存清理不删除 `eqpp.studyIndex` 与关键持久键（对照 `StorageUtilTest` 的保留键列表）。

6. [ ] UI/交互与模式选择
   - 目标：导入时弹出模式选择（合并/覆盖），保证提示文案与逻辑一致；导出/导入提示成功文案统一英文。
   - 参考需求：Req 5.1, 5.2, 5.3, 5.4
   - 子任务：
     - 6.1. [ ] 将模式选择提炼为函数（例如 `askImportMode()` 返回 `merge|overwrite`），当前实现使用 `confirm`，后续可演进为设置项（测试：函数返回值驱动不同分支）。
     - 6.2. [ ] 检查导出/导入的英文提示文案与提示位置（测试：模拟成功路径断言提示调用）。

7. [ ] 性能与大文件处理（基础防护）
   - 目标：对超大备份给出警告并允许中止导出；合并实现采用近线性复杂度；下载使用异步。
   - 参考需求：Req 1.7, 7.1, 7.2, 7.3
   - 子任务：
     - 7.1. [ ] 在导出前估算 JSON 字符串长度，超过阈值（如 50MB）给出 `Backup too large.` 警告并允许中止（测试：模拟大对象触发警告分支）。
     - 7.2. [ ] 使用 `Map` 与一次遍历实现 `mergeArrayById`，避免嵌套循环（测试：大数组合并的时间/正确性示意）。

8. [ ] 测试完善与覆盖
   - 目标：在 `src/test/java` 下补充与完善测试，文件以 `Test` 结尾，方法使用 `@Test` 注解；中文注释、英文断言消息。
   - 参考需求：Req 8.1, 8.2, 8.3, 8.4
   - 子任务：
     - 8.1. [ ] 扩展 `FullBackupTest`：
       - 新增断言：导出 `meta`/`payload` 键完整性；合并导入的细化断言（计数累加、时间取最新、设置浅合并、过滤规则覆盖）。
       - 覆盖导入成功路径断言（可通过模拟方法调用/事件触发标记）。
     - 8.2. [ ] 新建（或扩展）`StorageUtilTest`：验证保留键列表与类型容错逻辑。

9. [ ] 代码注释与可维护性
   - 目标：在关键逻辑处添加中文注释，解释合并策略与边界情况；避免一字母变量名，保持一致风格。
   - 参考需求：通用编码规范与可维护性目标
   - 子任务：
     - 9.1. [ ] 为合并函数与映射重建函数补充中文注释（测试无需，但用代码审阅确保覆盖）。

执行提示（供代码生成 LLM 使用）：
- 每步先写测试，再实现功能，确保不出现“大跨步”改动；每次实现仅影响与之相关的模块/函数。
- 仅进行编码活动（编写/修改文件、创建测试），不包含用户测试、部署、性能采集或运行端到端流程（可以编写自动化测试覆盖端到端视角）。
- 所有测试类置于 `src/test/java`，以 `Test` 结尾，使用 `@Test` 注解；中文注释 + 英文断言。
- 引用需求编号时确保覆盖《requirements.md》中的所有关键条目（合并/覆盖、映射一致性、错误处理、UI/UX、性能与测试要求）。
